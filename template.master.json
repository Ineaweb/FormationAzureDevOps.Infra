{
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{
    "storageUri":{
      "type":"string"
    },
    "storageKey":{
      "type":"string"
    },
    "project_name":{
      "type":"string"
    },
    "env_code":{
      "type":"string"
    },
    "region_code":{
      "type":"string"
    },
    "location":{
      "defaultValue":"West Europe",
      "type":"string"
    },
    "app_publishingUsername":{
      "type":"string"
    },
    "app_publishingPassword":{
      "type":"string"
    },
    "config_web_name":{
      "defaultValue":"web",
      "type":"string"
    },
    "function_app_exist":{
      "defaultValue":"False",
      "type":"string"
    }    
  },
  "variables":{
    "apiVersionOld":"[providers('Microsoft.Resources', 'deployments').apiVersions[0]]",
    "apiVersion":"2018-09-01"
  },
  "resources":[
    {
      "apiVersion":"[variables('apiVersion')]",
      "name":"appInsight",
      "type":"Microsoft.Resources/deployments",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[concat(parameters('storageUri'), 'components/template.appInsight.json', parameters('storageKey'))]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "project_name":{
            "value":"[parameters('project_name')]"
          },
          "env_code":{
            "value":"[parameters('env_code')]"
          },
          "region_code":{
            "value":"[parameters('region_code')]"
          }
        }
      }
    },
    {
      "apiVersion":"[variables('apiVersion')]",
      "name":"servicebus",
      "type":"Microsoft.Resources/deployments",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[concat(parameters('storageUri'), 'components/template.servicebus.json', parameters('storageKey'))]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "project_name":{
            "value":"[parameters('project_name')]"
          },
          "env_code":{
            "value":"[parameters('env_code')]"
          },
          "region_code":{
            "value":"[parameters('region_code')]"
          },
          "location":{
            "value":"[parameters('location')]"
          }
        }
      }
    },
    {
      "apiVersion":"[variables('apiVersion')]",
      "name":"storageaccount_app",
      "type":"Microsoft.Resources/deployments",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[concat(parameters('storageUri'), 'components/template.storageaccount.json', parameters('storageKey'))]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "project_name":{
            "value":"[parameters('project_name')]"
          },
          "env_code":{
            "value":"[parameters('env_code')]"
          },
          "region_code":{
            "value":"[parameters('region_code')]"
          },
          "location":{
            "value":"[parameters('location')]"
          },
          "storage_name":{
            "value":"glob"
          }
        }
      }
    },
    {
      "apiVersion":"[variables('apiVersion')]",
      "name":"serverfarm_app",
      "type":"Microsoft.Resources/deployments",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[concat(parameters('storageUri'), 'components/template.serverfarm.dynamic.json', parameters('storageKey'))]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "project_name":{
            "value":"[parameters('project_name')]"
          },
          "env_code":{
            "value":"[parameters('env_code')]"
          },
          "region_code":{
            "value":"[parameters('region_code')]"
          },
          "location":{
            "value":"[parameters('location')]"
          },
          "farm_name":{
            "value":"app"
          }
        }
      }
    },
    {
      "apiVersion":"[variables('apiVersion')]",
      "name":"function_app",
      "type":"Microsoft.Resources/deployments",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[concat(parameters('storageUri'), 'components/template.azurefunction', if(equals(toLower(parameters('function_app_exist')), 'true'), '_update', '_create'), '.json', parameters('storageKey'))]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "project_name":{
            "value":"[parameters('project_name')]"
          },
          "env_code":{
            "value":"[parameters('env_code')]"
          },
          "region_code":{
            "value":"[parameters('region_code')]"
          },
          "location":{
            "value":"[parameters('location')]"
          },
          "function_name":{
            "value":"app"
          },
          "farm_name":{
            "value":"app"
          },
          "storageAccount_connectionString":{
            "value":"[reference('storageaccount_app').outputs.connectionString.value]"
          },
          "function_publishingUsername":{
            "value":"[parameters('app_publishingUsername')]"
          },
          "function_publishingPassword":{
            "value":"[parameters('app_publishingPassword')]"
          }
        }
      },
      "dependsOn":[
        "[resourceId('Microsoft.Resources/deployments', 'serverfarm_app')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageaccount_app')]"
      ]
    }	
  ],
  "outputs":{
    "appinsightInstrumentationKey":{
      "type":"string",
      "value":"[reference('appInsight').outputs.instrumentationKey.value]"
    },
    "servicebusFunc01AutorizationConnectionString":{
      "type":"string",
      "value":"[reference('servicebus').outputs.func01AutorizationConnectionString.value]"
    },
    "servicebusFunc02AutorizationConnectionString":{
      "type":"string",
      "value":"[reference('servicebus').outputs.func02AutorizationConnectionString.value]"
    },
    "storageaccountAppName":{
      "type":"string",
      "value":"[reference('storageaccount_app').outputs.name.value]"
    },
    "storageaccountAppKey":{
      "type":"string",
      "value":"[reference('storageaccount_app').outputs.key.value]"
    },
    "storageaccountAppConnectionstring":{
      "type":"string",
      "value":"[reference('storageaccount_app').outputs.connectionString.value]"
    }	
  }
}